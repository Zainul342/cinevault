<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Watchlist | CineVault</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/design-system.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/layout.css">
    <link rel="stylesheet" href="assets/css/animations.css">
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="logo">
                <i class="fas fa-film"></i>
                <span>CineVault</span>
            </div>
            <ul class="nav-list">
                <li class="nav-item" data-page="dashboard">
                    <a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a>
                </li>
                <li class="nav-item" data-page="movies">
                    <a href="movies.html"><i class="fas fa-video"></i> Movies</a>
                </li>
                <li class="nav-item active" data-page="watchlist">
                    <a href="watchlist.html"><i class="fas fa-bookmark"></i> Watchlist</a>
                </li>
                <li class="nav-item" data-page="analytics">
                    <a href="analytics.html"><i class="fas fa-chart-bar"></i> Analytics</a>
                </li>
            </ul>
            <div class="user-profile">
                <i class="fas fa-user-circle"></i>
                <span>Guest</span>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="page-header">
                <div>
                    <h1>My Watchlist</h1>
                    <p class="text-muted">Movies you want to watch later</p>
                </div>
                <div class="watchlist-stats" id="watchlist-stats">
                    <span class="stat-badge"><i class="fas fa-bookmark"></i> <span id="stat-count">0</span>
                        movies</span>
                </div>
            </header>

            <!-- Recommendations Section -->
            <section class="content-section">
                <h2 class="section-title">
                    <i class="fas fa-magic"></i> Recommended For You
                </h2>
                <div id="recommendations-grid" class="movie-grid"></div>
            </section>

            <!-- Watchlist Section -->
            <section class="content-section">
                <h2 class="section-title">
                    <i class="fas fa-list"></i> Your Watchlist
                </h2>
                <div id="watchlist-grid" class="movie-grid"></div>

                <!-- Empty State -->
                <div id="empty-state" class="empty-state" style="display: none;">
                    <i class="fas fa-bookmark fa-3x"></i>
                    <h3>Your watchlist is empty</h3>
                    <p>Start adding movies you want to watch!</p>
                    <a href="movies.html" class="btn btn-primary">Browse Movies</a>
                </div>
            </section>
        </main>
    </div>

    <!-- Scripts -->
    <script src="assets/js/api.js"></script>
    <script src="assets/js/Toast.js"></script>
    <script src="assets/js/Modal.js"></script>
    <script src="assets/js/MovieCard.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const watchlistGrid = document.getElementById('watchlist-grid');
            const recommendationsGrid = document.getElementById('recommendations-grid');
            const emptyState = document.getElementById('empty-state');
            const statCount = document.getElementById('stat-count');

            // Check auth
            if (!API.auth.isLoggedIn()) {
                Toast.warning('Please login to view your watchlist');
                setTimeout(() => window.location.href = 'dashboard.html', 1500);
                return;
            }

            // Load watchlist and recommendations in parallel
            await Promise.all([loadWatchlist(), loadRecommendations()]);

            async function loadWatchlist() {
                watchlistGrid.innerHTML = '';
                watchlistGrid.appendChild(MovieCard.createSkeleton(4));

                try {
                    const res = await API.watchlist.list();
                    const items = res.watchlist || [];

                    statCount.textContent = items.length;

                    if (items.length === 0) {
                        watchlistGrid.innerHTML = '';
                        emptyState.style.display = 'flex';
                        return;
                    }

                    emptyState.style.display = 'none';
                    MovieCard.renderGrid(watchlistGrid, items, {
                        showActions: true,
                        onClick: (movie) => openMovieModal(movie),
                    });

                    // Mark watchlist buttons as active
                    watchlistGrid.querySelectorAll('.btn-watchlist').forEach(btn => {
                        btn.classList.add('active');
                    });
                } catch (err) {
                    watchlistGrid.innerHTML = '<p class="error">Failed to load watchlist</p>';
                    Toast.error('Could not load watchlist');
                }
            }

            async function loadRecommendations() {
                recommendationsGrid.innerHTML = '';
                recommendationsGrid.appendChild(MovieCard.createSkeleton(4));

                try {
                    const res = await API.recommendations(8);
                    const items = res.recommendations || [];

                    if (items.length === 0) {
                        recommendationsGrid.innerHTML = '<p class="text-muted">Like more movies to get personalized recommendations!</p>';
                        return;
                    }

                    MovieCard.renderGrid(recommendationsGrid, items, {
                        showActions: true,
                        onClick: (movie) => openMovieModal(movie),
                    });
                } catch (err) {
                    recommendationsGrid.innerHTML = '<p class="text-muted">Recommendations unavailable</p>';
                }
            }

            function openMovieModal(movie) {
                Modal.open({
                    title: movie.title,
                    size: 'large',
                    content: `
                        <div class="movie-detail flex gap-lg">
                            <img src="https://image.tmdb.org/t/p/w300${movie.poster_path || ''}" 
                                 alt="${movie.title}" 
                                 style="border-radius: var(--radius-sm); border: var(--border-width) solid var(--border-color);">
                            <div>
                                <p><strong>Release:</strong> ${movie.release_date || 'N/A'}</p>
                                <p><strong>Rating:</strong> ${movie.vote_average?.toFixed?.(1) || movie.vote_average || '-'}/10</p>
                                <p style="margin-top: 16px;">${movie.overview || 'No description available.'}</p>
                            </div>
                        </div>
                    `,
                    actions: [
                        { label: 'Close', onClick: () => Modal.close() }
                    ],
                });
            }

            // Handle movie actions
            document.addEventListener('movie:action', async (e) => {
                const { action, movie } = e.detail;
                const movieId = movie.id;

                const btn = document.querySelector(`[data-action="${action}"][data-movie-id="${movieId}"]`);

                try {
                    if (action === 'watchlist') {
                        btn?.classList.add('animating');
                        await API.watchlist.remove(movieId);
                        Toast.success(`"${movie.title}" removed from watchlist`);
                        await loadWatchlist();
                    } else if (action === 'like') {
                        btn?.classList.toggle('active');
                        btn?.classList.add('animating');
                        const res = await API.interactions.like(movieId);
                        Toast.success(res.liked ? 'Movie liked!' : 'Like removed');
                    }
                } catch (err) {
                    Toast.error(err.message || 'Action failed');
                } finally {
                    setTimeout(() => btn?.classList.remove('animating'), 300);
                }
            });

            // Update user profile
            try {
                const res = await API.auth.me();
                document.querySelector('.user-profile span').textContent = res.user?.name || 'User';
            } catch { }
        });
    </script>
</body>

</html>